<!DOCTYPE html>
<html lang="en" class="<%= typeof theme !== 'undefined' && theme === 'dark' ? 'dark' : '' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Hygiene — desiarr</title>
  <link rel="icon" type="image/svg+xml" href="/assets/desiarr-logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/app.css">
</head>
<body class="bg-[var(--bg)] text-[var(--text)] min-h-screen">
  <!-- Toast Notification Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  
  <%- include('partials/app-sidebar', { currentPage: 'data-hygiene' }) %>
  
  <div class="lg:pl-64">
    <%- include('partials/app-header', { currentSearch: typeof search !== 'undefined' ? search : '', lastRefresh: null }) %>
    
    <main class="p-4 lg:p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Data Hygiene</h2>

    <!-- Tab Navigation -->
    <div class="mb-6">
      <nav class="flex flex-wrap gap-2" role="tablist">
        <a
          href="/data-hygiene?view=missing-imdb"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'missing-imdb' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          Missing IMDB ID
        </a>
        <a
          href="/data-hygiene?view=non-indian"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'non-indian' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          Non-Indian Movies
        </a>
        <a
          href="/data-hygiene?view=file-names"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'file-names' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          File Names
        </a>
        <a
          href="/data-hygiene?view=folder-mismatch"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'folder-mismatch' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          Folder Name Mismatch
        </a>
        <a
          href="/data-hygiene?view=filename-mismatch"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'filename-mismatch' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          File Name Mismatch
        </a>
        <a
          href="/data-hygiene?view=language-mismatch"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'language-mismatch' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          Language Mismatch
        </a>
        <a
          href="/data-hygiene?view=deleted-titles"
          class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 <%= view === 'deleted-titles' ? 'bg-blue-500 text-white shadow-sm hover:bg-blue-600' : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600' %>"
          role="tab"
        >
          Deleted Titles
        </a>
      </nav>
    </div>

    <!-- Stats -->
    <div class="mb-4 flex items-center justify-between">
      <div class="text-sm text-gray-600 dark:text-gray-400">
        Total: <span class="font-semibold"><%= total %></span> movies
        <% if (search) { %>
          | Filtered: <span class="font-semibold"><%= filteredCount %></span>
        <% } %>
      </div>
    </div>

    <!-- Content Area -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
      <% if (movies.length === 0) { %>
        <div class="p-8 text-center text-gray-500 dark:text-gray-400">
          <p class="text-lg mb-2">No issues found!</p>
          <p class="text-sm">All movies in this category are clean.</p>
        </div>
      <% } else { %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Title</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Year</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">TMDB ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">IMDB ID</th>
                <% if (view === 'non-indian') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Language</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Origin Country</th>
                <% } %>
                <% if (view === 'file-names') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">File Name</th>
                <% } %>
                <% if (view === 'folder-mismatch') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Folder Name</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Expected</th>
                <% } %>
                <% if (view === 'filename-mismatch') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">File Name</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Expected</th>
                <% } %>
                <% if (view === 'language-mismatch') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Radarr Language</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">TMDB Language</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                <% } %>
                <% if (view === 'deleted-titles') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Has File</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                <% } %>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <% movies.forEach(movie => { %>
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                  <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100"><%= movie.title %></td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400"><%= movie.year || '-' %></td>
                  <td class="px-4 py-3 text-sm text-gray-600">
                    <% if (movie.tmdb_id) { %>
                      <a href="https://www.themoviedb.org/movie/<%= movie.tmdb_id %>" target="_blank" class="text-blue-600 hover:underline">
                        <%= movie.tmdb_id %>
                      </a>
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600">
                    <% if (movie.imdb_id) { %>
                      <a href="https://www.imdb.com/title/<%= movie.imdb_id %>" target="_blank" class="text-blue-600 hover:underline">
                        <%= movie.imdb_id %>
                      </a>
                    <% } else { %>
                      <span class="text-red-600">Missing</span>
                    <% } %>
                  </td>
                  <% if (view === 'non-indian') { %>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                      <%= movie.tmdb_original_language || movie.original_language || '-' %>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                      <%= movie.origin_country || '-' %>
                    </td>
                  <% } %>
                  <% if (view === 'file-names') { %>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 font-mono text-xs">
                      <%= movie.file_name || '-' %>
                    </td>
                  <% } %>
                  <% if (view === 'folder-mismatch') { %>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 font-mono text-xs">
                      <%= movie.folder_name || '-' %>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 font-mono text-xs">
                      <span class="text-green-600"><%= movie.expected_folder_name || '-' %></span>
                    </td>
                  <% } %>
                  <% if (view === 'filename-mismatch') { %>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 font-mono text-xs">
                      <%= movie.file_name || '-' %>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400 font-mono text-xs">
                      <span class="text-green-600"><%= movie.expected_file_name || '-' %></span>
                    </td>
                  <% } %>
                  <% if (view === 'language-mismatch') { %>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                      <%= movie.original_language || '-' %>
                      <% if (movie.radarr_language_code) { %>
                        <span class="text-xs text-gray-500">(<%= movie.radarr_language_code %>)</span>
                      <% } %>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                      <%= movie.tmdb_original_language || '-' %>
                      <% if (movie.tmdb_language_code) { %>
                        <span class="text-xs text-gray-500">(<%= movie.tmdb_language_code %>)</span>
                      <% } %>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <% if (movie.tmdb_id) { %>
                        <button
                          onclick="refreshTmdbData(<%= movie.tmdb_id %>)"
                          class="text-blue-600 hover:text-blue-800 text-xs"
                          title="Refresh TMDB data"
                        >
                          Refresh
                        </button>
                      <% } %>
                    </td>
                  <% } %>
                  <% if (view === 'deleted-titles') { %>
                    <td class="px-4 py-3 text-sm">
                      <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                        Deleted in TMDB
                      </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <% if (movie.has_file === 1) { %>
                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                          Yes
                        </span>
                      <% } else { %>
                        <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                          No
                        </span>
                      <% } %>
                    </td>
                    <td class="px-4 py-3 text-sm">
                      <div class="flex gap-2">
                        <% if (movie.has_file === 0) { %>
                          <!-- Update button: Only for movies without files -->
                          <button
                            onclick="updateTmdbId(<%= movie.radarr_id %>, '<%= movie.title %>', <%= movie.tmdb_id || 'null' %>)"
                            class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded transition-colors"
                            title="Update TMDB ID (safe - no files to preserve)"
                          >
                            Update
                          </button>
                        <% } else { %>
                          <!-- Replace button: Only for movies with files (placeholder) -->
                          <button
                            onclick="replaceTmdbId(<%= movie.radarr_id %>, '<%= movie.title %>', <%= movie.tmdb_id || 'null' %>)"
                            class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded transition-colors opacity-50 cursor-not-allowed"
                            title="Replace TMDB ID (coming soon - requires file preservation logic)"
                            disabled
                          >
                            Replace
                          </button>
                        <% } %>
                        <button
                          onclick="deleteMovie(<%= movie.radarr_id %>, '<%= movie.title %>', <%= movie.has_file === 1 ? 'true' : 'false' %>)"
                          class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white text-xs rounded transition-colors"
                          title="Delete this movie from Radarr"
                        >
                          Delete
                        </button>
                      </div>
                    </td>
                  <% } %>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
    </main>
  </div>

  <style>
    .toast-enter {
      animation: slideIn 0.3s forwards;
    }
    .toast-exit {
      animation: slideOut 0.3s forwards;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  </style>

  <script>
    // Toast notification function
    function showToast(message, type = 'info', duration = 5000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };
      
      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ'
      };
      
      toast.className = `${bgColors[type] || bgColors.info} text-white px-6 py-3 rounded-lg shadow-lg flex items-center justify-between min-w-[300px] max-w-md toast-enter`;
      toast.innerHTML = `
        <span class="flex items-center gap-2">
          <span class="text-lg font-bold">${icons[type] || icons.info}</span>
          <span>${message}</span>
        </span>
        <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 font-bold text-xl">×</button>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.remove('toast-enter');
        toast.classList.add('toast-exit');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // Confirmation dialog function
    function showConfirm(message, onConfirm, onCancel = null) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
          <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Confirm</h3>
          <p class="text-gray-700 dark:text-gray-300 mb-6 whitespace-pre-line">${message}</p>
          <div class="flex justify-end space-x-3">
            <button class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
              Cancel
            </button>
            <button class="confirm-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
              Confirm
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const removeOverlay = () => {
        overlay.remove();
      };
      
      overlay.querySelector('.confirm-btn').addEventListener('click', () => {
        removeOverlay();
        if (onConfirm) onConfirm();
      });
      
      overlay.querySelector('.cancel-btn').addEventListener('click', () => {
        removeOverlay();
        if (onCancel) onCancel();
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          removeOverlay();
          if (onCancel) onCancel();
        }
      });
    }

    // Prompt function (for TMDB ID input)
    function showPrompt(message, defaultValue = '', onConfirm, onCancel = null) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      overlay.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
          <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Input</h3>
          <p class="text-gray-700 dark:text-gray-300 mb-4 whitespace-pre-line">${message}</p>
          <input 
            type="text" 
            id="promptInput" 
            value="${defaultValue}" 
            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white mb-6"
            placeholder="Enter value..."
          />
          <div class="flex justify-end space-x-3">
            <button class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded transition-colors">
              Cancel
            </button>
            <button class="confirm-btn bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded transition-colors">
              OK
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      const input = overlay.querySelector('#promptInput');
      input.focus();
      input.select();
      
      const removeOverlay = () => {
        overlay.remove();
      };
      
      const handleConfirm = () => {
        const value = input.value.trim();
        removeOverlay();
        if (onConfirm) onConfirm(value);
      };
      
      overlay.querySelector('.confirm-btn').addEventListener('click', handleConfirm);
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleConfirm();
        }
      });
      
      overlay.querySelector('.cancel-btn').addEventListener('click', () => {
        removeOverlay();
        if (onCancel) onCancel();
      });
      
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          removeOverlay();
          if (onCancel) onCancel();
        }
      });
    }

    async function refreshTmdbData(tmdbId) {
      showConfirm('Refresh TMDB data for this movie?', async () => {
        try {
          showToast('Refreshing TMDB data...', 'info');
          const response = await fetch(`/data-hygiene/refresh-tmdb/${tmdbId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
          });

          const data = await response.json();

          if (data.success) {
            showToast('TMDB data refreshed successfully!', 'success');
            setTimeout(() => window.location.reload(), 1500);
          } else {
            showToast('Error: ' + (data.error || 'Failed to refresh TMDB data'), 'error');
          }
        } catch (error) {
          showToast('Error: ' + error.message, 'error');
        }
      });
    }

    async function deleteMovie(radarrId, title, hasFile) {
      const deleteFiles = hasFile === 'true' || hasFile === true;
      const message = deleteFiles
        ? `Delete "${title}" from Radarr?\n\nThis will:\n- Remove the movie from Radarr\n- Delete the movie file(s) from disk\n\nThis action cannot be undone.`
        : `Delete "${title}" from Radarr?\n\nThis will remove the movie from Radarr (no files will be deleted).\n\nThis action cannot be undone.`;

      showConfirm(message, () => {
        if (deleteFiles) {
          showConfirm('WARNING: This will delete the movie file(s) from disk. Are you absolutely sure?', async () => {
            await performDelete(radarrId, deleteFiles);
          });
        } else {
          performDelete(radarrId, deleteFiles);
        }
      });
    }

    async function performDelete(radarrId, deleteFiles) {
      try {
        showToast('Deleting movie...', 'info');
        const response = await fetch(`/data-hygiene/delete-movie/${radarrId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ deleteFiles: deleteFiles }),
        });

        const data = await response.json();
        if (data.success) {
          showToast('Movie deleted successfully', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast('Error: ' + (data.error || 'Failed to delete movie'), 'error');
        }
      } catch (error) {
        showToast('Error: ' + error.message, 'error');
      }
    }

    async function updateTmdbId(radarrId, title, currentTmdbId) {
      showPrompt(
        `Update TMDB ID for "${title}"?\n\nCurrent TMDB ID: ${currentTmdbId || 'None'}\n\nEnter the new TMDB ID:`,
        '',
        (newTmdbId) => {
          if (!newTmdbId || newTmdbId.trim() === '') {
            return;
          }

          const tmdbIdNum = parseInt(newTmdbId.trim(), 10);
          if (isNaN(tmdbIdNum) || tmdbIdNum <= 0) {
            showToast('Invalid TMDB ID. Please enter a positive number.', 'error');
            return;
          }

          showConfirm(
            `Update TMDB ID from ${currentTmdbId || 'None'} to ${tmdbIdNum}?\n\nThis will:\n- Delete the movie from Radarr (no files will be deleted)\n- Re-add the movie with the new TMDB ID\n\nThis is safe because the movie has no files.`,
            async () => {
              try {
                showToast('Updating TMDB ID...', 'info');
                const response = await fetch(`/data-hygiene/update-tmdb-id/${radarrId}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ tmdbId: tmdbIdNum }),
                });

                const data = await response.json();
                if (data.success) {
                  showToast('TMDB ID updated successfully', 'success');
                  setTimeout(() => location.reload(), 1500);
                } else {
                  showToast('Error: ' + (data.error || 'Failed to update TMDB ID'), 'error');
                }
              } catch (error) {
                showToast('Error: ' + error.message, 'error');
              }
            }
          );
        }
      );
    }

    function replaceTmdbId(radarrId, title, currentTmdbId) {
      showToast('Replace functionality is not yet implemented. This requires careful file preservation logic.', 'warning');
    }
  </script>
  <script src="/js/ui.js"></script>
</body>
</html>

