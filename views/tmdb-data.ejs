<!DOCTYPE html>
<html lang="en" class="<%= typeof theme !== 'undefined' && theme === 'dark' ? 'dark' : '' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TMDB Data â€” desiarr</title>
  <link rel="icon" type="image/svg+xml" href="/assets/desiarr-logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/app.css">
</head>
<body class="bg-[var(--bg)] text-[var(--text)] min-h-screen">
  <%- include('partials/app-sidebar', { currentPage: 'tmdb-data' }) %>
  
  <div class="lg:pl-64">
    <%- include('partials/app-header', { currentSearch: typeof search !== 'undefined' ? search : '', lastRefresh: typeof lastSyncDate !== 'undefined' ? lastSyncDate : null }) %>
    
    <main class="p-4 lg:p-6">
    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">TMDB Data</h2>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
      <nav class="flex space-x-8" aria-label="Tabs">
        <a
          href="/tmdb-data"
          class="<%= typeof view === 'undefined' || view !== 'backfill' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300' %> whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
        >
          All Movies
        </a>
        <a
          href="/tmdb-data/backfill"
          class="<%= typeof view !== 'undefined' && view === 'backfill' ? 'border-blue-500 text-blue-600 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300' %> whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm"
        >
          Backfill Missing Data
        </a>
      </nav>
    </div>

    <% if (typeof view !== 'undefined' && view === 'backfill') { %>
      <!-- Backfill View -->
      <div class="mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
          <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between mb-4">
            <div class="flex-1">
              <label for="missingField" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Filter by Missing Field
              </label>
              <select
                id="missingField"
                onchange="window.location.href = '/tmdb-data/backfill?missing=' + this.value + '<%= typeof search !== 'undefined' && search ? '&search=' + encodeURIComponent(search) : '' %>'"
                class="w-full md:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="origin_country" <%= typeof missingField !== 'undefined' && missingField === 'origin_country' ? 'selected' : '' %>>Missing Origin Country</option>
                <option value="release_date" <%= typeof missingField !== 'undefined' && missingField === 'release_date' ? 'selected' : '' %>>Missing Release Date</option>
                <option value="overview" <%= typeof missingField !== 'undefined' && missingField === 'overview' ? 'selected' : '' %>>Missing Overview</option>
                <option value="tagline" <%= typeof missingField !== 'undefined' && missingField === 'tagline' ? 'selected' : '' %>>Missing Tagline</option>
                <option value="homepage" <%= typeof missingField !== 'undefined' && missingField === 'homepage' ? 'selected' : '' %>>Missing Homepage</option>
                <option value="primary_country" <%= typeof missingField !== 'undefined' && missingField === 'primary_country' ? 'selected' : '' %>>Missing Primary Country</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button
                onclick="selectAllMovies(false)"
                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm"
                title="Select all movies on this page"
              >
                Select All (Page)
              </button>
              <button
                onclick="selectAllMovies(true)"
                class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm"
                title="Select all movies across all pages"
              >
                Select All (<%= typeof selectAllTotal !== 'undefined' ? selectAllTotal : total %>)
              </button>
              <button
                onclick="backfillSelected()"
                id="backfillButton"
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm"
              >
                Backfill Selected (<span id="selectedCount">0</span>)
              </button>
            </div>
          </div>

          <!-- Search Bar -->
          <form method="GET" action="/tmdb-data/backfill" class="mb-4">
            <input type="hidden" name="missing" value="<%= typeof missingField !== 'undefined' ? missingField : 'origin_country' %>" />
            <div class="flex gap-2">
              <input
                type="text"
                name="search"
                value="<%= typeof search !== 'undefined' ? search : '' %>"
                placeholder="Search by title, TMDB ID..."
                class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
              <button
                type="submit"
                class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
              >
                Search
              </button>
              <% if (typeof search !== 'undefined' && search) { %>
                <a
                  href="/tmdb-data/backfill?missing=<%= typeof missingField !== 'undefined' ? missingField : 'origin_country' %>"
                  class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors"
                >
                  Clear
                </a>
              <% } %>
            </div>
          </form>
        </div>

        <!-- Progress Bar -->
        <div id="backfillProgressContainer" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
          <div class="flex items-center justify-between mb-2">
            <span id="backfillProgressStep" class="text-sm font-medium text-gray-700 dark:text-gray-300">Starting backfill...</span>
            <span id="backfillProgressPercent" class="text-sm text-gray-600 dark:text-gray-400">0%</span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
            <div id="backfillProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
            <span id="backfillProgressStats">Processing...</span>
          </div>
        </div>
      </div>
    <% } %>
    
    <% if (typeof view === 'undefined' || view !== 'backfill') { %>
      <!-- All Movies View -->
      <div class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-4">
          <div class="text-right">
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Cached: <span class="font-semibold"><%= totalCached %></span> movies
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Pending: <span class="font-semibold"><%= pendingUpdates %></span> movies
            </div>
            <% if (lastSyncDate) { %>
              <div class="text-sm text-gray-600 dark:text-gray-400">
                Last sync: <span class="font-semibold" id="lastSyncTime" data-utc="<%= lastSyncDate %>">Loading...</span>
              </div>
            <% } else { %>
              <div class="text-sm text-yellow-600 dark:text-yellow-400">
                Never synced
              </div>
            <% } %>
          </div>
          <button 
            id="syncButton"
            onclick="startIncrementalSync()" 
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            <%= typeof isSyncing !== 'undefined' && isSyncing ? 'disabled' : '' %>
          >
            <svg id="syncIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span id="syncButtonText"><%= typeof isSyncing !== 'undefined' && isSyncing ? 'Syncing...' : 'Sync Now' %></span>
          </button>
        </div>
      </div>
      
      <!-- Progress Bar -->
      <div id="progressContainer" class="<%= typeof isSyncing !== 'undefined' && isSyncing ? '' : 'hidden' %> bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4">
        <div class="flex items-center justify-between mb-2">
          <span id="progressStep" class="text-sm font-medium text-gray-700 dark:text-gray-300">Starting sync...</span>
          <span id="progressPercent" class="text-sm text-gray-600 dark:text-gray-400">0%</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
          <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
          <span id="progressStats">Processing...</span>
        </div>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
      <form method="GET" action="/tmdb-data" class="flex gap-2">
        <input
          type="text"
          name="search"
          value="<%= typeof search !== 'undefined' ? search : '' %>"
          placeholder="Search by title, language, country, year, IMDB/TMDB ID..."
          class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          type="submit"
          class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
        >
          Search
        </button>
        <% if (typeof search !== 'undefined' && search) { %>
          <a
            href="/tmdb-data"
            class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors"
          >
            Clear
          </a>
        <% } %>
      </form>
    </div>
    <% } %>

    <!-- Movies Table (shared for both views) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
      <% if (typeof movies !== 'undefined' && movies.length > 0) { %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <% if (typeof view !== 'undefined' && view === 'backfill') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleAllMovies(this.checked)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                  </th>
                <% } %>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Poster</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Title</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Year</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Language</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Origin Country (TMDB)</th>
                <% if (typeof view !== 'undefined' && view === 'backfill' && typeof missingField !== 'undefined' && missingField === 'origin_country') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Primary Country (Derived)</th>
                <% } %>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">IMDB ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">TMDB ID</th>
                <% if (typeof view === 'undefined' || view !== 'backfill') { %>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                <% } %>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <% movies.forEach(movie => { %>
                <tr 
                  class="hover:bg-gray-50 dark:hover:bg-gray-700 <%= typeof view !== 'undefined' && view === 'backfill' ? '' : 'cursor-pointer' %>"
                  <%= typeof view === 'undefined' || view !== 'backfill' ? 'onclick="window.location.href=\'/tmdb-data/movie/' + movie.tmdb_id + '\'"' : '' %>
                >
                  <% if (typeof view !== 'undefined' && view === 'backfill') { %>
                    <td class="px-4 py-3" onclick="event.stopPropagation()">
                      <input 
                        type="checkbox" 
                        class="movie-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                        value="<%= movie.tmdb_id %>"
                        onchange="updateSelectedCount()"
                      />
                    </td>
                  <% } %>
                  <td class="px-4 py-3">
                    <% if (movie.poster_path) { %>
                      <img 
                        src="https://image.tmdb.org/t/p/w92<%= movie.poster_path %>" 
                        alt="<%= movie.title %> poster"
                        class="w-16 h-24 object-cover rounded"
                        onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'92\' height=\'138\'%3E%3Crect fill=\'%23ddd\' width=\'92\' height=\'138\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'12\'%3ENo Image%3C/text%3E%3C/svg%3E'"
                      />
                    <% } else { %>
                      <div class="w-16 h-24 bg-gray-200 dark:bg-gray-700 rounded flex items-center justify-center text-xs text-gray-400">
                        No Poster
                      </div>
                    <% } %>
                  </td>
                  <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100">
                    <%= movie.title || '-' %>
                    <% if (movie.original_title && movie.original_title !== movie.title) { %>
                      <div class="text-xs text-gray-500 dark:text-gray-400 italic">
                        <%= movie.original_title %>
                      </div>
                    <% } %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                    <%= movie.release_date ? new Date(movie.release_date).getFullYear() : '-' %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                    <%= movie.original_language_display || movie.original_language || '-' %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                    <span class="<%= typeof movie.origin_country_display === 'undefined' || !movie.origin_country_display ? 'text-red-600 font-semibold' : 'text-gray-600' %>">
                      <%= typeof movie.origin_country_display !== 'undefined' && movie.origin_country_display ? movie.origin_country_display : '-' %>
                    </span>
                  </td>
                  <% if (typeof view !== 'undefined' && view === 'backfill' && typeof missingField !== 'undefined' && missingField === 'origin_country') { %>
                    <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 italic">
                      <%= movie.primary_country || '-' %>
                      <span class="text-xs text-gray-400">(from production_countries)</span>
                    </td>
                  <% } %>
                  <td class="px-4 py-3 text-sm text-gray-600">
                    <% if (movie.imdb_id) { %>
                      <a 
                        href="https://www.imdb.com/title/<%= movie.imdb_id %>" 
                        target="_blank" 
                        class="text-blue-600 hover:underline"
                        onclick="event.stopPropagation()"
                      >
                        <%= movie.imdb_id %>
                      </a>
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600">
                    <% if (movie.tmdb_id) { %>
                      <a 
                        href="https://www.themoviedb.org/movie/<%= movie.tmdb_id %>" 
                        target="_blank" 
                        class="text-blue-600 hover:underline"
                        onclick="event.stopPropagation()"
                      >
                        <%= movie.tmdb_id %>
                      </a>
                    <% } else { %>
                      -
                    <% } %>
                  </td>
                  <% if (typeof view === 'undefined' || view !== 'backfill') { %>
                    <td class="px-4 py-3 text-sm">
                      <button
                        onclick="refreshMovie(<%= movie.tmdb_id %>, event)"
                        class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 rounded hover:bg-blue-50 dark:hover:bg-blue-900 transition-colors"
                        title="Refresh TMDB data for this movie"
                        id="refresh-btn-<%= movie.tmdb_id %>"
                      >
                        <svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <span class="ml-1" id="refresh-text-<%= movie.tmdb_id %>">Refresh</span>
                      </button>
                    </td>
                  <% } %>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
          <% 
            const baseUrl = typeof view !== 'undefined' && view === 'backfill' ? '/tmdb-data/backfill' : '/tmdb-data';
            const queryParams = [];
            if (typeof view !== 'undefined' && view === 'backfill' && typeof missingField !== 'undefined') {
              queryParams.push('missing=' + encodeURIComponent(missingField));
            }
            if (typeof search !== 'undefined' && search) {
              queryParams.push('search=' + encodeURIComponent(search));
            }
            const queryPrefix = queryParams.length > 0 ? '?' + queryParams.join('&') + '&' : '?';
          %>
          <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-600 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
              <% if (typeof currentPageNum !== 'undefined' && currentPageNum > 1) { %>
                <a 
                  href="<%= baseUrl %><%= queryPrefix %>page=<%= currentPageNum - 1 %>" 
                  class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                >
                  Previous
                </a>
              <% } else { %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-300 dark:text-gray-600 bg-white dark:bg-gray-800 cursor-not-allowed">
                  Previous
                </span>
              <% } %>
              <% if (typeof currentPageNum !== 'undefined' && currentPageNum < totalPages) { %>
                <a 
                  href="<%= baseUrl %><%= queryPrefix %>page=<%= currentPageNum + 1 %>" 
                  class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                >
                  Next
                </a>
              <% } else { %>
                <span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-300 dark:text-gray-600 bg-white dark:bg-gray-800 cursor-not-allowed">
                  Next
                </span>
              <% } %>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
              <div>
                <p class="text-sm text-gray-700 dark:text-gray-300">
                  Showing <span class="font-medium"><%= typeof currentPageNum !== 'undefined' ? ((currentPageNum - 1) * 50) + 1 : 1 %></span> to 
                  <span class="font-medium"><%= typeof currentPageNum !== 'undefined' && typeof total !== 'undefined' ? Math.min(currentPageNum * 50, total) : 50 %></span> of 
                  <span class="font-medium"><%= typeof total !== 'undefined' ? total : 0 %></span> results
                </p>
              </div>
              <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                  <% if (typeof currentPageNum !== 'undefined' && currentPageNum > 1) { %>
                    <a 
                      href="<%= baseUrl %><%= queryPrefix %>page=<%= currentPageNum - 1 %>" 
                      class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700"
                    >
                      Previous
                    </a>
                  <% } else { %>
                    <span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-300 dark:text-gray-600 cursor-not-allowed">
                      Previous
                    </span>
                  <% } %>
                  
                  <% for (let i = Math.max(1, (typeof currentPageNum !== 'undefined' ? currentPageNum : 1) - 2); i <= Math.min(totalPages, (typeof currentPageNum !== 'undefined' ? currentPageNum : 1) + 2); i++) { %>
                    <% if (i === (typeof currentPageNum !== 'undefined' ? currentPageNum : 1)) { %>
                      <span class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 dark:bg-blue-900 text-sm font-medium text-blue-600 dark:text-blue-300">
                        <%= i %>
                      </span>
                    <% } else { %>
                      <a 
                        href="<%= baseUrl %><%= queryPrefix %>page=<%= i %>" 
                        class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
                      >
                        <%= i %>
                      </a>
                    <% } %>
                  <% } %>
                  
                  <% if (typeof currentPageNum !== 'undefined' && currentPageNum < totalPages) { %>
                    <a 
                      href="<%= baseUrl %><%= queryPrefix %>page=<%= currentPageNum + 1 %>" 
                      class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700"
                    >
                      Next
                    </a>
                  <% } else { %>
                    <span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-300 dark:text-gray-600 cursor-not-allowed">
                      Next
                    </span>
                  <% } %>
                </nav>
              </div>
            </div>
          </div>
        <% } %>
      <% } else { %>
        <div class="p-8 text-center text-gray-500 dark:text-gray-400">
          <p class="text-lg mb-2">No TMDB data found.</p>
          <p class="text-sm">
            <% if (typeof search !== 'undefined' && search) { %>
              Try a different search term or <a href="/tmdb-data" class="text-blue-600 hover:underline">clear the search</a>.
            <% } else { %>
              Click "Sync Now" to fetch data from TMDB.
            <% } %>
          </p>
        </div>
      <% } %>
    </div>
    </main>
  </div>

  <script>
    <% 
      // Set default missingField for JavaScript
      const defaultMissingField = typeof missingField !== 'undefined' ? missingField : 'origin_country';
    %>
    let progressInterval = null;
    const defaultMissingFieldValue = '<%= defaultMissingField %>';

    function updateProgress() {
      fetch('/tmdb-data/sync/progress')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.progress) {
            const progress = data.progress;
            const progressContainer = document.getElementById('progressContainer');
            const progressStep = document.getElementById('progressStep');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const progressStats = document.getElementById('progressStats');
            const syncButton = document.getElementById('syncButton');
            const syncButtonText = document.getElementById('syncButtonText');

            if (progress.isRunning) {
              progressContainer.classList.remove('hidden');
              if (syncButton) {
                syncButton.disabled = true;
                syncButtonText.textContent = 'Syncing...';
              }
              const initialSyncButton = document.getElementById('initialSyncButton');
              if (initialSyncButton) {
                initialSyncButton.disabled = true;
              }

              progressStep.textContent = progress.currentStep || 'Processing...';
              
              // Use the pre-calculated progress (0-100)
              progressBar.style.width = progress.progress + '%';
              progressPercent.textContent = progress.progress + '%';
              
              if (progress.total > 0) {
                progressStats.textContent = `Processed: ${progress.processed} / ${progress.total}${progress.errors > 0 ? ` | Errors: ${progress.errors}` : ''}`;
              } else if (progress.currentStep) {
                progressStats.textContent = progress.currentStep;
              }
            } else {
              progressContainer.classList.add('hidden');
              if (syncButton) {
                syncButton.disabled = false;
                syncButtonText.textContent = 'Sync Now';
              }
              const initialSyncButton = document.getElementById('initialSyncButton');
              if (initialSyncButton) {
                initialSyncButton.disabled = false;
              }
              if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
              }
              // Reload page to show updated stats
              setTimeout(() => window.location.reload(), 1000);
            }
          }
        })
        .catch(error => {
          console.error('Failed to fetch progress:', error);
        });
    }

    async function startInitialSync() {
      const button = document.getElementById('initialSyncButton');
      if (button && button.disabled) {
        return;
      }

      if (!confirm('Initial sync will fetch data for all movies in Radarr. This may take a while. Continue?')) {
        return;
      }

      try {
        const response = await fetch('/tmdb-data/sync/initial', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();

        if (data.success) {
          // Start polling for progress
          if (!progressInterval) {
            progressInterval = setInterval(updateProgress, 1000);
            updateProgress();
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to start sync'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    async function startIncrementalSync() {
      const button = document.getElementById('syncButton');
      if (button && button.disabled) {
        return;
      }

      try {
        const response = await fetch('/tmdb-data/sync/incremental', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();

        if (data.success) {
          // Start polling for progress
          if (!progressInterval) {
            progressInterval = setInterval(updateProgress, 1000);
            updateProgress();
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to start sync'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Check if sync is already running on page load
    <% if (typeof isSyncing !== 'undefined' && isSyncing) { %>
      if (!progressInterval) {
        progressInterval = setInterval(updateProgress, 1000);
        updateProgress();
      }
    <% } %>

    // Format last sync time in user's local timezone (same as header)
    // Use the same pattern as ui.js for consistency
    (function() {
      function formatLastSyncTime() {
        const lastSyncElement = document.getElementById('lastSyncTime');
        if (lastSyncElement && lastSyncElement.dataset.utc) {
          try {
            const utcDate = new Date(lastSyncElement.dataset.utc);
            // Format in user's local timezone with timezone info
            const options = {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              timeZoneName: 'short'
            };
            lastSyncElement.textContent = utcDate.toLocaleString(undefined, options);
          } catch (e) {
            console.error('Error formatting last sync time:', e);
          }
        }
      }
      
      // Run immediately if DOM is ready, otherwise wait
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', formatLastSyncTime);
      } else {
        formatLastSyncTime();
      }
      
      // Also try again after a short delay to catch any timing issues
      setTimeout(formatLastSyncTime, 100);
    })();

    // Backfill functions (defined for all views, but only used in backfill view)
    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('.movie-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('backfillButton').disabled = count === 0;
    }

    function toggleAllMovies(checked) {
      const checkboxes = document.querySelectorAll('.movie-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checked;
      });
      updateSelectedCount();
    }

    function selectAllMovies(allPages = false) {
      if (allPages) {
        // Select all across all pages - store in sessionStorage
        const missingField = document.getElementById('missingField')?.value || '<%= typeof missingField !== "undefined" ? missingField : "origin_country" %>';
        const total = <%= typeof selectAllTotal !== 'undefined' ? selectAllTotal : total %>;
        sessionStorage.setItem('tmdbBackfillSelectAll', 'true');
        sessionStorage.setItem('tmdbBackfillMissingField', missingField);
        sessionStorage.setItem('tmdbBackfillTotal', total.toString());
        // Check all checkboxes on current page
        toggleAllMovies(true);
        // Update count to show total
        document.getElementById('selectedCount').textContent = total;
        document.getElementById('backfillButton').disabled = false;
        alert(`Selected all ${total} movies across all pages. Click "Backfill Selected" to process them.`);
      } else {
        // Select all on current page only
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = true;
          toggleAllMovies(true);
        }
        // Clear sessionStorage
        sessionStorage.removeItem('tmdbBackfillSelectAll');
      }
    }

    let backfillProgressInterval = null;

    function updateBackfillProgress() {
      fetch('/tmdb-data/sync/progress')
        .then(res => res.json())
        .then(data => {
          if (data.success && data.progress && data.progress.type === 'tmdb-backfill') {
            const progress = data.progress;
            const progressContainer = document.getElementById('backfillProgressContainer');
            const progressStep = document.getElementById('backfillProgressStep');
            const progressBar = document.getElementById('backfillProgressBar');
            const progressPercent = document.getElementById('backfillProgressPercent');
            const progressStats = document.getElementById('backfillProgressStats');
            const backfillButton = document.getElementById('backfillButton');

            if (progress.isRunning) {
              progressContainer.classList.remove('hidden');
              if (backfillButton) {
                backfillButton.disabled = true;
              }

              progressStep.textContent = progress.currentStep || 'Processing...';
              progressBar.style.width = progress.progress + '%';
              progressPercent.textContent = progress.progress + '%';

              if (progress.total > 0) {
                progressStats.textContent = `Processed: ${progress.processed} / ${progress.total}${progress.errors > 0 ? ` | Errors: ${progress.errors}` : ''}`;
              } else if (progress.currentStep) {
                progressStats.textContent = progress.currentStep;
              }
            } else {
              progressContainer.classList.add('hidden');
              if (backfillButton) {
                backfillButton.disabled = false;
              }
              if (backfillProgressInterval) {
                clearInterval(backfillProgressInterval);
                backfillProgressInterval = null;
              }
              // Reload page to show updated data
              setTimeout(() => window.location.reload(), 1000);
            }
          }
        })
        .catch(error => {
          console.error('Failed to fetch backfill progress:', error);
        });
    }

    async function backfillSelected() {
      const missingFieldEl = document.getElementById('missingField');
      const missingField = missingFieldEl ? missingFieldEl.value : defaultMissingFieldValue;

      // Check if "Select All (All Pages)" was used
      const selectAllFlag = sessionStorage.getItem('tmdbBackfillSelectAll') === 'true';
      let selectedIds = [];

      if (selectAllFlag) {
        // Fetch all IDs from the server
        try {
          const response = await fetch(`/tmdb-data/backfill/ids?missing=${encodeURIComponent(missingField)}&search=`);
          const data = await response.json();
          if (data.success && data.ids) {
            selectedIds = data.ids;
          } else {
            alert('Error fetching all movie IDs: ' + (data.error || 'Unknown error'));
            return;
          }
        } catch (error) {
          console.error('Error fetching all movie IDs:', error);
          alert('Error fetching all movie IDs: ' + error.message);
          return;
        }
      } else {
        // Use checkboxes on current page
        const checkboxes = document.querySelectorAll('.movie-checkbox:checked');
        selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value, 10));
      }

      if (selectedIds.length === 0) {
        alert('Please select at least one movie to backfill');
        return;
      }

      // Clear sessionStorage after getting IDs
      if (selectAllFlag) {
        sessionStorage.removeItem('tmdbBackfillSelectAll');
        sessionStorage.removeItem('tmdbBackfillMissingField');
        sessionStorage.removeItem('tmdbBackfillTotal');
      }
      
      if (!confirm(`Backfill ${selectedIds.length} movie(s) for missing ${missingField}?`)) {
        return;
      }

      console.log(`[Backfill] Starting backfill for ${selectedIds.length} movies, missingField: ${missingField}`);

      try {
        const response = await fetch('/tmdb-data/backfill', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tmdbIds: selectedIds,
            missingField: missingField,
          }),
        });

        const data = await response.json();

        if (data.success) {
          // Show progress container immediately
          const progressContainer = document.getElementById('backfillProgressContainer');
          if (progressContainer) {
            progressContainer.classList.remove('hidden');
          }
          
          // Start polling for progress
          if (!backfillProgressInterval) {
            backfillProgressInterval = setInterval(updateBackfillProgress, 1000);
            updateBackfillProgress();
          }
        } else {
          alert('Error: ' + (data.error || 'Failed to start backfill'));
        }
      } catch (error) {
        console.error('Backfill error:', error);
        alert('Error: ' + (error.message || 'Failed to start backfill'));
      }
    }

    // Initialize selected count on page load (only if in backfill view)
    <% if (typeof view !== 'undefined' && view === 'backfill') { %>
    updateSelectedCount();
    <% } %>

    async function refreshMovie(tmdbId, event) {
      if (event) {
        event.stopPropagation(); // Prevent row click
      }

      const button = document.getElementById(`refresh-btn-${tmdbId}`);
      const text = document.getElementById(`refresh-text-${tmdbId}`);
      
      if (!button || !text) return;

      // Disable button and show loading state
      button.disabled = true;
      button.classList.add('opacity-50', 'cursor-not-allowed');
      text.textContent = 'Refreshing...';

      try {
        const response = await fetch(`/tmdb-data/refresh/${tmdbId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();

        if (data.success) {
          text.textContent = 'Refreshed!';
          button.classList.remove('text-blue-600', 'hover:text-blue-800');
          button.classList.add('text-green-600');
          
          // Reload page after a short delay to show updated data
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          text.textContent = 'Error';
          button.classList.remove('text-blue-600', 'hover:text-blue-800');
          button.classList.add('text-red-600');
          alert('Error: ' + (data.error || 'Failed to refresh movie'));
          
          // Reset after 2 seconds
          setTimeout(() => {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed', 'text-red-600');
            button.classList.add('text-blue-600', 'hover:text-blue-800');
            text.textContent = 'Refresh';
          }, 2000);
        }
      } catch (error) {
        text.textContent = 'Error';
        button.classList.remove('text-blue-600', 'hover:text-blue-800');
        button.classList.add('text-red-600');
        alert('Error: ' + error.message);
        
        // Reset after 2 seconds
        setTimeout(() => {
          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-not-allowed', 'text-red-600');
          button.classList.add('text-blue-600', 'hover:text-blue-800');
          text.textContent = 'Refresh';
        }, 2000);
      }
    }
  </script>
  <script src="/js/ui.js"></script>
</body>
</html>
