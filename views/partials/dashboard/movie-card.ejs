<%
  // Determine movie-level decision based on priority
  let decision = 'PENDING';
  let decisionReason = 'No releases found';
  let decisionBadgeClass = 'badge-info';
  
  if (movie.add && movie.add.length > 0) {
    decision = 'APPROVED';
    decisionReason = `${movie.add.length} new release(s) available`;
    decisionBadgeClass = 'badge-success';
  } else if (movie.upgrade && movie.upgrade.length > 0) {
    decision = 'UPGRADE';
    decisionReason = `${movie.upgrade.length} upgrade candidate(s)`;
    decisionBadgeClass = 'badge-warning';
  } else if (movie.existing && movie.existing.length > 0) {
    decision = 'EXISTING';
    decisionReason = 'Already in Radarr';
    decisionBadgeClass = 'badge-info';
  } else if (movie.ignored && movie.ignored.length > 0) {
    decision = 'IGNORED';
    decisionReason = 'All releases ignored (doesn\'t meet requirements)';
    decisionBadgeClass = 'badge-neutral';
  }
  
  // Get total release count
  const totalReleases = (movie.add?.length || 0) + (movie.existing?.length || 0) + (movie.upgrade?.length || 0) + (movie.ignored?.length || 0);
  
  // Get year from releases if not available
  let movieYear = null;
  if (movie.add && movie.add.length > 0 && movie.add[0].year) {
    movieYear = movie.add[0].year;
  } else if (movie.existing && movie.existing.length > 0 && movie.existing[0].year) {
    movieYear = movie.existing[0].year;
  } else if (movie.upgrade && movie.upgrade.length > 0 && movie.upgrade[0].year) {
    movieYear = movie.upgrade[0].year;
  }
%>

<article class="card overflow-hidden mb-4 relative" 
         data-movie-id="<%= movie.tmdbId || 'unknown' %>"
         data-language="<%= (movie.originalLanguage || '').toLowerCase() %>"
         data-status="<%= decision.toLowerCase() %>">
  <!-- Type Indicator Icon -->
  <% if (typeof showTypeIcon !== 'undefined' && showTypeIcon) { %>
    <div class="absolute top-2 right-2 z-10 bg-blue-600 text-white rounded-full p-1.5 shadow-lg" title="Movie">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path>
      </svg>
    </div>
  <% } %>
  <div class="p-4 flex gap-4">
    <!-- Poster and Action Button -->
    <div class="flex-shrink-0 flex flex-col gap-3">
      <% if (movie.posterUrl) { %>
        <img 
          src="<%= movie.posterUrl %>" 
          alt="<%= movie.movieTitle %> poster" 
          class="w-28 h-40 object-cover rounded-xl shadow-lg"
          loading="lazy"
        />
      <% } else { %>
        <div class="w-28 h-40 bg-gray-200 dark:bg-gray-700 rounded-xl shadow-lg flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs text-center p-2">
          No Poster
        </div>
      <% } %>
      
      <!-- Action Button Below Poster -->
      <% 
        // Determine primary action button
        let primaryRelease = null;
        let primaryAction = null;
        
        if (movie.add && movie.add.length > 0) {
          primaryRelease = movie.add[0];
          primaryAction = 'add';
        } else if (movie.upgrade && movie.upgrade.length > 0) {
          primaryRelease = movie.upgrade[0];
          primaryAction = 'upgrade';
        } else if (movie.ignored && movie.ignored.length > 0 && movie.tmdbId && !movie.radarrMovieId) {
          primaryRelease = movie.ignored[0];
          primaryAction = 'add';
        }
      %>
      
      <% if (primaryRelease && primaryAction === 'add') { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium text-sm add-to-radarr" 
          data-id="<%= primaryRelease.id %>"
          onclick="addMovie(<%= primaryRelease.id %>)"
          aria-label="Add to Radarr"
        >
          Add to Radarr
        </button>
      <% } else if (primaryRelease && primaryAction === 'upgrade') { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-orange-500 text-white hover:bg-orange-600 transition-colors font-medium text-sm" 
          onclick="upgradeMovie(<%= primaryRelease.id %>)"
          aria-label="Upgrade in Radarr"
        >
          Upgrade
        </button>
      <% } %>
      
      <!-- Re-categorize button for unmatched items -->
      <% if (!movie.tmdbId && !movie.radarrMovieId && movie.rssItemId) { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-purple-500 text-white hover:bg-purple-600 transition-colors font-medium text-sm mt-2" 
          onclick="reCategorizeItem(<%= movie.rssItemId %>, 'tv')"
          aria-label="Move to TV Shows"
          title="This appears to be a TV show. Move it to TV Shows section."
        >
          Move to TV Shows
        </button>
      <% } %>
    </div>

    <!-- Movie Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate"><%= movie.movieTitle %></h3>
        
        <% if (movieYear) { %>
          <span class="badge badge-neutral"><%= movieYear %></span>
        <% } %>
        
        <% if (movie.originalLanguage) { %>
          <span class="badge badge-neutral flex items-center gap-1">
            <%= movie.originalLanguage %>
            <% if (movie.isIndianLanguage === false) { %>
              <svg class="w-4 h-4 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="Not a major Indian language">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
              </svg>
            <% } %>
          </span>
        <% } %>

        <!-- Decision Badge -->
        <span class="badge <%= decisionBadgeClass %>" title="<%= decisionReason %>">
          <%= decision %>
        </span>

        <!-- IMDB Link -->
        <% if (movie.imdbId) { %>
          <a 
            href="https://www.imdb.com/title/<%= movie.imdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open IMDB"
            title="View on IMDB"
          >
            <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400" style="font-family: Arial, sans-serif;">IMDb</span>
          </a>
        <% } %>

        <!-- TMDB Link -->
        <% if (movie.tmdbId) { %>
          <a 
            href="https://www.themoviedb.org/movie/<%= movie.tmdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open TMDB"
            title="View on TMDB"
          >
            <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" style="font-family: Arial, sans-serif;">TMDb</span>
          </a>
        <% } %>

        <!-- Radarr Link -->
        <% if (movie.radarrMovieId && typeof radarrBaseUrl !== 'undefined') { %>
          <a 
            href="<%= radarrBaseUrl %>/movie/<%= movie.radarrMovieId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="View in Radarr"
            title="View in Radarr"
          >
            <span class="text-[10px] font-bold text-[#3C85C6]" style="font-family: Arial, sans-serif;">Radarr</span>
          </a>
        <% } %>
      </div>

      <!-- Decision Reason (if ignored) -->
      <% if (decision === 'IGNORED' && decisionReason) { %>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">Reason: <%= decisionReason %></div>
      <% } %>

      <!-- Radarr Data Section - Styled Box -->
      <% if (movie.radarrInfo) { %>
        <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 rounded-lg">
          <!-- Header -->
          <div class="flex items-center gap-2 mb-3">
            <svg class="w-4 h-4 text-[#3C85C6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
            </svg>
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Radarr Data</h4>
          </div>

          <!-- Last Downloaded Filename with Source and Size (Top Row) -->
          <% if (movie.radarrInfo.lastDownload && movie.radarrInfo.lastDownload.sourceTitle) { %>
            <div class="mb-3">
              <div class="flex items-start gap-3 flex-wrap">
                <div class="flex-1 min-w-0">
                  <span class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Last Downloaded Filename</span>
                  <div class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded text-xs break-words font-mono" title="<%= movie.radarrInfo.lastDownload.sourceTitle %>">
                    <%= movie.radarrInfo.lastDownload.sourceTitle %>
                  </div>
                </div>
                <!-- Source -->
                <% if (movie.radarrInfo.sourceTag && movie.radarrInfo.sourceTag !== 'OTHER') { %>
                  <div class="flex-shrink-0">
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Source</span>
                    <span class="inline-block px-3 py-1.5 bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 rounded-md font-semibold text-sm">
                      <% if (movie.radarrInfo.sourceTag === 'Bluray') { %>
                        <span class="text-blue-600 dark:text-blue-400">Bluray</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'DVD') { %>
                        <span class="text-green-600 dark:text-green-400">DVD</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'WEB-DL') { %>
                        <span class="text-indigo-600 dark:text-indigo-400">WEB-DL<% if (movie.radarrInfo.sourceSite) { %> <span class="text-orange-600 dark:text-orange-400"><%= movie.radarrInfo.sourceSite %></span><% } %></span>
                      <% } else if (movie.radarrInfo.sourceTag === 'WEBRip') { %>
                        <span class="text-indigo-500 dark:text-indigo-400">WEBRip<% if (movie.radarrInfo.sourceSite) { %> <span class="text-orange-600 dark:text-orange-400"><%= movie.radarrInfo.sourceSite %></span><% } %></span>
                      <% } else if (movie.radarrInfo.sourceTag === 'AMZN') { %>
                        <span class="text-orange-600 dark:text-orange-400">AMZN</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'NF' || movie.radarrInfo.sourceTag === 'Netflix') { %>
                        <span class="text-red-600 dark:text-red-400">NF</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'DSNP' || movie.radarrInfo.sourceTag === 'Disney' || movie.radarrInfo.sourceTag === 'Hotstar') { %>
                        <span class="text-blue-600 dark:text-blue-400">DSNP</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'ZEE5' || movie.radarrInfo.sourceTag === 'Zee5') { %>
                        <span class="text-purple-600 dark:text-purple-400">ZEE5</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'JC' || movie.radarrInfo.sourceTag === 'JioCinema') { %>
                        <span class="text-green-600 dark:text-green-400">JC</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'HS' || movie.radarrInfo.sourceTag === 'Hotstar') { %>
                        <span class="text-blue-600 dark:text-blue-400">HS</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'SS') { %>
                        <span class="text-indigo-600 dark:text-indigo-400">SS</span>
                      <% } else { %>
                        <%= movie.radarrInfo.sourceTag %>
                      <% } %>
                    </span>
                  </div>
                <% } %>
                <!-- Size -->
                <% if (movie.radarrInfo.sizeMb) { %>
                  <div class="flex-shrink-0">
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Size</span>
                    <%
                      const sizeGiB = typeof movie.radarrInfo.sizeMb === 'number' ? (movie.radarrInfo.sizeMb / 1024) : (parseFloat(movie.radarrInfo.sizeMb) / 1024);
                    %>
                    <span class="inline-block px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-semibold"><%= sizeGiB.toFixed(2) %> GiB</span>
                  </div>
                <% } %>
              </div>
            </div>
          <% } else if (movie.radarrInfo.fileName) { %>
            <div class="mb-3">
              <div class="flex items-start gap-3 flex-wrap">
                <div class="flex-1 min-w-0">
                  <span class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Filename</span>
                  <div class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded text-xs break-words font-mono" title="<%= movie.radarrInfo.fileName %>">
                    <%= movie.radarrInfo.fileName %>
                  </div>
                </div>
                <!-- Source -->
                <% if (movie.radarrInfo.sourceTag && movie.radarrInfo.sourceTag !== 'OTHER') { %>
                  <div class="flex-shrink-0">
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Source</span>
                    <span class="inline-block px-3 py-1.5 bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 rounded-md font-semibold text-sm">
                      <% if (movie.radarrInfo.sourceTag === 'Bluray') { %>
                        <span class="text-blue-600 dark:text-blue-400">Bluray</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'DVD') { %>
                        <span class="text-green-600 dark:text-green-400">DVD</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'WEB-DL') { %>
                        <span class="text-indigo-600 dark:text-indigo-400">WEB-DL<% if (movie.radarrInfo.sourceSite) { %> <span class="text-orange-600 dark:text-orange-400"><%= movie.radarrInfo.sourceSite %></span><% } %></span>
                      <% } else if (movie.radarrInfo.sourceTag === 'WEBRip') { %>
                        <span class="text-indigo-500 dark:text-indigo-400">WEBRip<% if (movie.radarrInfo.sourceSite) { %> <span class="text-orange-600 dark:text-orange-400"><%= movie.radarrInfo.sourceSite %></span><% } %></span>
                      <% } else if (movie.radarrInfo.sourceTag === 'AMZN') { %>
                        <span class="text-orange-600 dark:text-orange-400">AMZN</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'NF' || movie.radarrInfo.sourceTag === 'Netflix') { %>
                        <span class="text-red-600 dark:text-red-400">NF</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'DSNP' || movie.radarrInfo.sourceTag === 'Disney' || movie.radarrInfo.sourceTag === 'Hotstar') { %>
                        <span class="text-blue-600 dark:text-blue-400">DSNP</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'ZEE5' || movie.radarrInfo.sourceTag === 'Zee5') { %>
                        <span class="text-purple-600 dark:text-purple-400">ZEE5</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'JC' || movie.radarrInfo.sourceTag === 'JioCinema') { %>
                        <span class="text-green-600 dark:text-green-400">JC</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'HS' || movie.radarrInfo.sourceTag === 'Hotstar') { %>
                        <span class="text-blue-600 dark:text-blue-400">HS</span>
                      <% } else if (movie.radarrInfo.sourceTag === 'SS') { %>
                        <span class="text-indigo-600 dark:text-indigo-400">SS</span>
                      <% } else { %>
                        <%= movie.radarrInfo.sourceTag %>
                      <% } %>
                    </span>
                  </div>
                <% } %>
                <!-- Size -->
                <% if (movie.radarrInfo.sizeMb) { %>
                  <div class="flex-shrink-0">
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1 block">Size</span>
                    <%
                      const sizeGiB = typeof movie.radarrInfo.sizeMb === 'number' ? (movie.radarrInfo.sizeMb / 1024) : (parseFloat(movie.radarrInfo.sizeMb) / 1024);
                    %>
                    <span class="inline-block px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md text-sm font-semibold"><%= sizeGiB.toFixed(2) %> GiB</span>
                  </div>
                <% } %>
              </div>
            </div>
          <% } %>

          <!-- Metadata in One Line: Video Codec | Audio Info | Size | Quality | Release Group -->
          <div class="flex flex-wrap items-center gap-2 text-xs">
            <!-- Video Codec -->
            <% if (movie.radarrInfo.codec && movie.radarrInfo.codec !== 'UNKNOWN') { %>
              <div class="flex items-center gap-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Video Codec:</span>
                <span class="px-2 py-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 rounded"><%= movie.radarrInfo.codec %></span>
              </div>
            <% } %>

            <!-- Audio Info -->
            <% if (movie.radarrInfo.audio && movie.radarrInfo.audio !== 'Unknown') { %>
              <div class="flex items-center gap-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Audio Info:</span>
                <span class="px-2 py-1 bg-yellow-100 dark:bg-yellow-900/40 text-yellow-800 dark:text-yellow-200 rounded"><%= movie.radarrInfo.audio %></span>
              </div>
            <% } %>

            <!-- Size (if not shown above) -->
            <% if (movie.radarrInfo.sizeMb && (!movie.radarrInfo.lastDownload || !movie.radarrInfo.lastDownload.sourceTitle) && !movie.radarrInfo.fileName) { %>
              <div class="flex items-center gap-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Size:</span>
                <%
                  const sizeGiB = typeof movie.radarrInfo.sizeMb === 'number' ? (movie.radarrInfo.sizeMb / 1024) : (parseFloat(movie.radarrInfo.sizeMb) / 1024);
                %>
                <span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded"><%= sizeGiB.toFixed(2) %> GiB</span>
              </div>
            <% } %>

            <!-- Quality -->
            <% if (movie.radarrInfo.quality) { %>
              <div class="flex items-center gap-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Quality:</span>
                <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 rounded"><%= movie.radarrInfo.quality %></span>
              </div>
            <% } else if (movie.radarrInfo.resolution && movie.radarrInfo.resolution !== 'UNKNOWN') { %>
              <div class="flex items-center gap-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Quality:</span>
                <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 rounded"><%= movie.radarrInfo.resolution %></span>
              </div>
            <% } %>

            <!-- Release Group -->
            <% if (movie.radarrInfo.lastDownload && movie.radarrInfo.lastDownload.releaseGroup) { %>
              <div class="flex items-center gap-1">
                <span class="text-gray-600 dark:text-gray-400 font-medium">Release Group:</span>
                <span class="px-2 py-1 bg-purple-100 dark:bg-purple-900/40 text-purple-800 dark:text-purple-200 rounded font-mono"><%= movie.radarrInfo.lastDownload.releaseGroup %></span>
              </div>
            <% } %>
          </div>
        </div>
      <% } %>

      <!-- Release Table -->
      <div class="mt-3">
        <%- include('release-table', { movie }) %>
      </div>
    </div>
  </div>
</article>

