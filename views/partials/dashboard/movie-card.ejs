<%
  // Determine movie-level decision based on priority
  let decision = 'PENDING';
  let decisionReason = 'No releases found';
  let decisionBadgeClass = 'badge-info';
  
  if (movie.add && movie.add.length > 0) {
    decision = 'APPROVED';
    decisionReason = `${movie.add.length} new release(s) available`;
    decisionBadgeClass = 'badge-success';
  } else if (movie.upgrade && movie.upgrade.length > 0) {
    decision = 'UPGRADE';
    decisionReason = `${movie.upgrade.length} upgrade candidate(s)`;
    decisionBadgeClass = 'badge-warning';
  } else if (movie.existing && movie.existing.length > 0) {
    decision = 'EXISTING';
    decisionReason = 'Already in Radarr';
    decisionBadgeClass = 'badge-info';
  } else if (movie.ignored && movie.ignored.length > 0) {
    decision = 'IGNORED';
    decisionReason = 'All releases ignored (doesn\'t meet requirements)';
    decisionBadgeClass = 'badge-neutral';
  }
  
  // Get total release count
  const totalReleases = (movie.add?.length || 0) + (movie.existing?.length || 0) + (movie.upgrade?.length || 0) + (movie.ignored?.length || 0);
  
  // Get year from releases if not available
  let movieYear = null;
  if (movie.add && movie.add.length > 0 && movie.add[0].year) {
    movieYear = movie.add[0].year;
  } else if (movie.existing && movie.existing.length > 0 && movie.existing[0].year) {
    movieYear = movie.existing[0].year;
  } else if (movie.upgrade && movie.upgrade.length > 0 && movie.upgrade[0].year) {
    movieYear = movie.upgrade[0].year;
  }
%>

<article class="card overflow-hidden mb-4" 
         data-movie-id="<%= movie.tmdbId || 'unknown' %>"
         data-language="<%= (movie.originalLanguage || '').toLowerCase() %>"
         data-status="<%= decision.toLowerCase() %>">
  <div class="p-4 flex gap-4">
    <!-- Poster -->
    <div class="flex-shrink-0">
      <% if (movie.posterUrl) { %>
        <img 
          src="<%= movie.posterUrl %>" 
          alt="<%= movie.movieTitle %> poster" 
          class="w-28 h-40 object-cover rounded-xl shadow-lg"
          loading="lazy"
        />
      <% } else { %>
        <div class="w-28 h-40 bg-gray-200 dark:bg-gray-700 rounded-xl shadow-lg flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs text-center p-2">
          No Poster
        </div>
      <% } %>
    </div>

    <!-- Movie Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate"><%= movie.movieTitle %></h3>
        
        <% if (movieYear) { %>
          <span class="badge badge-neutral"><%= movieYear %></span>
        <% } %>
        
        <% if (movie.originalLanguage) { %>
          <span class="badge badge-neutral uppercase"><%= movie.originalLanguage %></span>
        <% } %>

        <!-- Decision Badge -->
        <span class="badge <%= decisionBadgeClass %>" title="<%= decisionReason %>">
          <%= decision %>
        </span>

        <!-- IMDB Link -->
        <% if (movie.imdbId) { %>
          <a 
            href="https://www.imdb.com/title/<%= movie.imdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn" 
            aria-label="Open IMDB"
            title="View on IMDB"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 3h7v7M10 14L21 3M21 21H3V3"/>
            </svg>
          </a>
        <% } %>

        <!-- TMDB Link -->
        <% if (movie.tmdbId) { %>
          <a 
            href="https://www.themoviedb.org/movie/<%= movie.tmdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn" 
            aria-label="Open TMDB"
            title="View on TMDB"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="9"/>
            </svg>
          </a>
        <% } %>

        <!-- Radarr Link -->
        <% if (movie.radarrMovieId && typeof radarrBaseUrl !== 'undefined') { %>
          <a 
            href="<%= radarrBaseUrl %>/movie/<%= movie.radarrMovieId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn" 
            aria-label="View in Radarr"
            title="View in Radarr"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </a>
        <% } %>
      </div>

      <!-- Decision Reason (if ignored) -->
      <% if (decision === 'IGNORED' && decisionReason) { %>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">Reason: <%= decisionReason %></div>
      <% } %>

      <!-- Release Table -->
      <div class="mt-3">
        <%- include('partials/dashboard/release-table', { movie }) %>
      </div>
    </div>

    <!-- Action Column -->
    <div class="w-44 flex flex-col items-end justify-between flex-shrink-0">
      <% 
        // Determine primary action button
        let primaryRelease = null;
        let primaryAction = null;
        
        if (movie.add && movie.add.length > 0) {
          primaryRelease = movie.add[0];
          primaryAction = 'add';
        } else if (movie.upgrade && movie.upgrade.length > 0) {
          primaryRelease = movie.upgrade[0];
          primaryAction = 'upgrade';
        } else if (movie.ignored && movie.ignored.length > 0 && movie.tmdbId && !movie.radarrMovieId) {
          primaryRelease = movie.ignored[0];
          primaryAction = 'add';
        }
      %>
      
      <% if (primaryRelease && primaryAction === 'add') { %>
        <button 
          class="px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium text-sm add-to-radarr" 
          data-id="<%= primaryRelease.id %>"
          onclick="addMovie(<%= primaryRelease.id %>)"
          aria-label="Add to Radarr"
        >
          Add to Radarr
        </button>
      <% } else if (primaryRelease && primaryAction === 'upgrade') { %>
        <button 
          class="px-3 py-2 rounded-xl bg-orange-500 text-white hover:bg-orange-600 transition-colors font-medium text-sm" 
          onclick="upgradeMovie(<%= primaryRelease.id %>)"
          aria-label="Upgrade in Radarr"
        >
          Upgrade
        </button>
      <% } else if (movie.radarrMovieId) { %>
        <div class="text-xs text-gray-500 dark:text-gray-400 text-right">
          <div>In Radarr</div>
          <% if (movie.radarrInfo && movie.radarrInfo.fileName) { %>
            <div class="mt-1 truncate max-w-[150px]" title="<%= movie.radarrInfo.fileName %>">
              <%= movie.radarrInfo.fileName %>
            </div>
          <% } %>
        </div>
      <% } %>
      
      <div class="text-xs text-gray-500 dark:text-gray-400 mt-2 text-right">
        <div>Releases: <%= totalReleases %></div>
        <% if (movie.add && movie.add.length > 0) { %>
          <div class="text-green-600 dark:text-green-400">Add: <%= movie.add.length %></div>
        <% } %>
        <% if (movie.upgrade && movie.upgrade.length > 0) { %>
          <div class="text-orange-600 dark:text-orange-400">Upgrade: <%= movie.upgrade.length %></div>
        <% } %>
        <% if (movie.existing && movie.existing.length > 0) { %>
          <div class="text-blue-600 dark:text-blue-400">Existing: <%= movie.existing.length %></div>
        <% } %>
        <% if (movie.ignored && movie.ignored.length > 0) { %>
          <div class="text-gray-600 dark:text-gray-400">Ignored: <%= movie.ignored.length %></div>
        <% } %>
      </div>
    </div>
  </div>
</article>

