<%
  // Determine show-level decision based on status (matching Movies structure)
  let decision = 'PENDING';
  let decisionReason = 'No releases found';
  let decisionBadgeClass = 'badge-info';
  
  if (show.newShows && show.newShows.length > 0) {
    decision = 'NEW';
    decisionReason = `${show.newShows.length} new release(s) available`;
    decisionBadgeClass = 'badge-success';
  } else if (show.existingShows && show.existingShows.length > 0) {
    decision = 'EXISTING';
    decisionReason = 'Already in Sonarr';
    decisionBadgeClass = 'badge-info';
  } else if (show.unmatched && show.unmatched.length > 0) {
    decision = 'UNMATCHED';
    decisionReason = 'No TVDB/TMDB ID found';
    decisionBadgeClass = 'badge-neutral';
  }
  
  // Get total release count
  const totalReleases = (show.newShows?.length || 0) + (show.existingShows?.length || 0) + (show.unmatched?.length || 0);
  
  // Get all releases for display
  const allReleases = [...(show.newShows || []), ...(show.existingShows || []), ...(show.unmatched || [])];
%>

<article class="card overflow-hidden mb-4 relative" 
         data-show-id="<%= show.tvdbId || show.tmdbId || 'unknown' %>"
         data-status="<%= decision.toLowerCase() %>">
  <!-- Type Indicator Icon -->
  <% if (typeof showTypeIcon !== 'undefined' && showTypeIcon) { %>
    <div class="absolute top-2 right-2 z-10 bg-purple-600 text-white rounded-full p-1.5 shadow-lg" title="TV Show">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
      </svg>
    </div>
  <% } %>
  <div class="p-4 flex gap-4">
    <!-- Poster and Action Button -->
    <div class="flex-shrink-0 flex flex-col gap-3">
      <% if (show.posterUrl) { %>
        <img 
          src="<%= show.posterUrl %>" 
          alt="<%= show.showName %> poster" 
          class="w-28 h-40 object-cover rounded-xl shadow-lg"
          loading="lazy"
        />
      <% } else { %>
        <div class="w-28 h-40 bg-gray-200 dark:bg-gray-700 rounded-xl shadow-lg flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs text-center p-2">
          No Poster
        </div>
      <% } %>
      
      <!-- Action Button Below Poster -->
      <% 
        // Determine primary action button - show "Add to Sonarr" for new shows (not in Sonarr)
        let primaryRelease = null;
        let primaryAction = null;
        
        if (show.newShows && show.newShows.length > 0 && !show.sonarrSeriesId) {
          primaryRelease = show.newShows[0];
          primaryAction = 'add';
        }
      %>
      
      <% if (primaryRelease && primaryAction === 'add') { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition-colors font-medium text-sm add-to-sonarr" 
          data-id="<%= primaryRelease.id %>"
          onclick="addTvShow(<%= primaryRelease.id %>)"
          aria-label="Add to Sonarr"
        >
          Add to Sonarr
        </button>
      <% } %>
      
      <!-- Re-categorize button for unmatched items -->
      <% if (!show.tvdbId && !show.tmdbId && !show.sonarrSeriesId && show.rssItemId) { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-purple-500 text-white hover:bg-purple-600 transition-colors font-medium text-sm mt-2" 
          onclick="reCategorizeItem(<%= show.rssItemId %>, 'movie')"
          aria-label="Move to Movies"
          title="This appears to be a movie. Move it to Movies section."
        >
          Move to Movies
        </button>
      <% } %>
      <% if (!show.manuallyIgnored && show.ignoreReleaseId) { %>
        <button 
          class="w-full px-3 py-2 rounded-xl bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium text-sm"
          onclick="ignoreTvShow(<%= show.ignoreReleaseId %>)"
          aria-label="Ignore TV show"
        >
          Ignore Show
        </button>
      <% } %>
    </div>

    <!-- Show Info -->
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-2">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate"><%= show.showName %></h3>
        
        <!-- Decision Badge -->
        <span class="badge <%= decisionBadgeClass %>" title="<%= decisionReason %>">
          <%= decision.replace('_', ' ') %>
        </span>

        <!-- TVDB Link -->
        <% if (show.tvdbId && show.tvdbUrl) { %>
          <a 
            href="<%= show.tvdbUrl %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open TVDB"
            title="View on TVDB"
          >
            <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" style="font-family: Arial, sans-serif;">TVDB</span>
          </a>
        <% } %>

        <!-- TMDB Link -->
        <% if (show.tmdbId) { %>
          <a 
            href="https://www.themoviedb.org/tv/<%= show.tmdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open TMDB"
            title="View on TMDB"
          >
            <span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" style="font-family: Arial, sans-serif;">TMDb</span>
          </a>
        <% } %>

        <!-- IMDB Link -->
        <% if (show.imdbId) { %>
          <a 
            href="https://www.imdb.com/title/<%= show.imdbId %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="Open IMDB"
            title="View on IMDB"
          >
            <span class="text-[10px] font-bold text-yellow-600 dark:text-yellow-400" style="font-family: Arial, sans-serif;">IMDb</span>
          </a>
        <% } %>

        <!-- Sonarr Link -->
        <% if (show.sonarrSeriesId && typeof sonarrBaseUrl !== 'undefined' && sonarrBaseUrl) { %>
          <% 
            // Sonarr uses TVDB slug format but with triple dashes instead of single dashes
            // Convert TVDB slug (single dashes) to Sonarr format (triple dashes)
            let sonarrLinkPath = show.sonarrSeriesId; // Fallback to ID
            if (show.tvdbSlug) {
              // Replace single dashes with triple dashes for Sonarr URL format
              sonarrLinkPath = show.tvdbSlug.replace(/-/g, '---');
            }
          %>
          <a 
            href="<%= sonarrBaseUrl %>/series/<%= sonarrLinkPath %>" 
            target="_blank" 
            rel="noreferrer" 
            class="icon-btn inline-flex items-center justify-center" 
            aria-label="View in Sonarr"
            title="View in Sonarr"
          >
            <span class="text-[10px] font-bold text-[#3C85C6]" style="font-family: Arial, sans-serif;">Sonarr</span>
          </a>
        <% } %>
      </div>

      <!-- Decision Reason -->
      <% if (decisionReason) { %>
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400"><%= decisionReason %></div>
      <% } %>

      <!-- Releases List - Compact Display -->
      <div class="mt-3 space-y-1.5">
        <% allReleases.forEach((release, index) => { %>
          <div class="flex items-center justify-between gap-2 py-1.5 px-2 bg-gray-50 dark:bg-gray-800/30 rounded">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 flex-wrap">
                <span class="font-medium text-sm text-gray-900 dark:text-white break-words" title="<%= release.title || release.show_name || 'Unknown Release' %>">
                  <%= release.title || release.show_name || 'Unknown Release' %>
                </span>
                <% if (release.season_number !== null && release.season_number !== undefined) { %>
                  <span class="text-xs text-gray-500 dark:text-gray-400">S<%= release.season_number %></span>
                <% } %>
                <% if (release.feedName) { %>
                  <span class="text-xs text-gray-500 dark:text-gray-400">â€¢</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400"><%= release.feedName %></span>
                <% } %>
              </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
              <% if (release.status === 'NEW_SHOW' || release.status === 'NEW_SEASON') { %>
                <span class="badge badge-success text-xs">NEW</span>
              <% } else if (release.status === 'IGNORED' || release.status === 'ADDED') { %>
                <span class="badge badge-info text-xs">EXISTING</span>
              <% } else { %>
                <span class="badge badge-neutral text-xs">UNMATCHED</span>
              <% } %>
              <% if (release.link) { %>
                <a 
                  href="<%= release.link %>" 
                  target="_blank" 
                  rel="noreferrer"
                  class="text-xs text-blue-600 dark:text-blue-400 hover:underline"
                  title="View Release"
                >
                  View
                </a>
              <% } %>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  </div>
</article>

